---
title: "Simulation study"
author: "Hanne Oberman"
date: "4-3-2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

This document contains the code and results for a simulation study accompanying the Standardized Evaluation manuscript.

# Overview 

The simulation contains a whopping set of `r 3*3*3*4*3*2*4*3` methods/conditions. That's because we use different parameters for each level of the simulation, see pseudo-code:

```
for (data geneneration conditions) {
  generate complete data
  for (amputation conditions) {
    ampute complete data
    for (imputation conditions) {
      impute incomplete data
      analyze imputed data
      }}}
```

The conditions are as follows. 

Data generation conditions:

- number of observations ($n = \{50, 500, 5000\}$) *only max required*
- number of variables ($p = \{2\}$)
- coherence between variables ($r = \{0, 0.4, 0.8\}$)

Amputation conditions:

- missingness mechanism (`mech` = {MCAR, MAR, MNAR})
- type of M(N)AR (`type` = {LEFT, RIGHT, MID, TAIL})
- missingness proportion (`prop` = {0.1, 0.25, 0.5})

Imputation conditions:

- imputation method (`meth` = {none, mean imputation, regression imputation, stochastic regression})
- number of imputations (`m` = {1, 5}) *only max required*
- number of iterations (`maxit` = 1, 5, 10) *use mice.mids to shorten runtime?*

Performance evaluation:
- estimand (average, regression coefficient)
- diagnostic (bias, coverage rate, confidence interval width, cell rmse, analysis model rmse)

# Simulation functions

For data generation we use the following:

```{r dat}
generation <- function(r, n = c(50, 500, 5000), p = 2) {
  # generate data based on variance-covariance matrix
  vcov <- matrix(r, p, p)
  diag(vcov) <- 1
  dat <- data.frame(mvtnorm::rmvnorm(
    n = max(n),
    mean = rep(0, p),
    sigma = vcov
  )) %>% setNames(paste0("X", 1:p))
  # split output by number of observations
  out <- purrr::map(n, ~{
    list(n_obs = .x,
         p = p,
         r = r,
         dat = dat[1:.x,])
  })
  return(out)
}
```

For amputation of the complete data:

```{r amp}
amputation <- function(dat, mech, type, prop) {
  # induce missingness
  amp <- dat %>%
    mice::ampute(prop = prop,
                 mech = mech,
                 type = type)
  # output
  out <- amp
  return(out)
}
```

To impute the incomplete data:

```{r imp}
imputation <- function(amp, meth, m = 5, it = 10) {
  imp <- amp$amp %>%
    mice::mice(
      m = m,
      method = meth,
      maxit = it,
      print = FALSE
    )
  # output
  out <- imp
  return(out)
}
```

And finally, for performance evaluation:

```{r perf}

```

